# Flood Detection System

This project is a Python-based tool for automatic flood extent extraction from pre- and post-disaster satellite images. It integrates multiple image processing algorithms and machine learning techniques, including Isolation Forest anomaly detection, 16 automatic Threshold Segmentation Methods (TSMs), and the Segment Anything Model (SAM) for precise segmentation, enabling efficient and accurate disaster area identification with visualization capabilities.
Download pre-/post-disaster example data and SAM checkpoints from: https://drive.google.com/drive/folders/1gSYvmGVykqwkja6svvRNM7HBT6XF43Ek
## Core Modules
- Data Preprocessing Module: read and process multi-temporal remote sensing images, and compute change detection features.
- Anomaly Detection Module: calculate normalized anomaly scores using the Isolation Forest algorithm.
- TSM Module: perform image segmentation via 16 TSMs to generate TSM-based flood detection results.
- SAM Module: execute image segmentation using the SAM to produce SAM-based flood detection results.
- Result Fusion Module: integrate TSM and SAM segmentation outputs to derive final flood detection results.

## Core Function Specifications

### read_and_process_flood_data(params)
Reads and preprocesses pre-/post-disaster remote sensing data.
- **Parameters:**
  - `params`: Dictionary containing processing parameters, including:
    - `filename1`: Path to pre-disaster image.
    - `filename2`: Path to post-disaster image.
    - `filename3`: (Optional) Path to ROI mask.
    - `change_method`: Feature difference calculation method ('difference'/'ratio'/'rate_of_change').
    - `roi_type`: ROI type (1: No ROI, 2: ROI for specific land class).
    - `spectral_bands`: List of spectral bands to use.
- **Returns:**
  - `ROI_pre_decision_result`: Anomaly scores computed using Isolation Forest.
  - `ROIvalues`: ROI mask.
  - `metadata`: Image metadata.

### threshold_analysis(ROI_pre_decision_result, ROIvalues, parameters)
Flood detection using 16 TSMs.
- **Parameters:**
  - `ROI_pre_decision_result`: Anomaly scores computed using Isolation Forest.
  - `ROIvalues`: ROI mask.
  - `parameters`: Parameter dictionary.
    - `visualize`: Boolean flag for result visualization (True/False)
    - `combined_threshold`: Detection count threshold for flood identification using the TSMs. A pixel is classified as flooded only if its detected flood occurrences ≥ this threshold.
- **Returns:**
  - A dictionary comprising two sets of flood detection outcomes: individual results from 16 distinct TSMs and aggregated results integrating 16 TSMs.

### sam_analysis(ROI_pre_decision_result, Threshold_merge, ROIvalues, parameters)
Flood detection using the SAM.
- **Parameters:**
  - `ROI_pre_decision_result`: Anomaly scores computed using Isolation Forest.
  - `Threshold_merge`: Flood detection results integrated from 16 TSMs.
  - `ROIvalues`: ROI mask.
  - `parameters`: Parameter dictionary.
- **Returns:**
  - Flood detection results generated by the Segment Anything Model (SAM).

### merge_segmentations_full(Threshold_merge, SAM_mask, parameters)
Integrated flood detection results combining TSM and SAM.
- **Parameters:**
  - `Threshold_merge`: Flood detection results integrated from 16 TSMs.
  - `SAM_mask`: Flood detection results generated by SAM.
  - `parameters`: Parameter dictionary.
- **Returns:**
  - Final flood detection results.


## Core Parameter Description
- `regionname`: Name of the region to be analyzed. Example: 'Example'.
- `change_method`: Method for computing change features. Options:
    - `rate_of_change`: (Post-disaster value − Pre-disaster value) / Post-disaster value
    - `difference`: Post-disaster value − Pre-disaster value
    - `ratio`: Post-disaster value / Pre-disaster value
    - Example: rate_of_change.
- `roi_type`: Region of Interest (ROI) type. Options:
    - 1: No ROI
    - 2: ROI based on specific land cover (e.g., cropland mask)
    - Example: 1.
- `spectral_bands`: Specific bands to be used. For Sentinel-1 data, select bands [0, 1, 3] from the sample data, where:
    - 0: VV polarization
    - 1: VH polarization
    - 3: VV/VH ratio
- `filename1`: Local file path for pre-flood image (used when data_source='local').
    - Example: 'flood_detection/data/BeforeFlooding.tif'.
- `filename2`: Local file path for post-flood image (used when data_source='local').
    - Example: 'flood_detection/data/AfterFlooding.tif'.
- `filename3`: Local file path for ROI data (used when data_source='local').
    - Example: 'flood_detection/data/ROI.tif'.
- `combined_threshold`: Detection count threshold set for flood identification using the TSM. A pixel is finally classified as flooded only if its detected flood occurrences ≥ this threshold.
    - Example: 15 (A pixel is classified as flooded when ≥13 out of 16 TSMs agree on flood detection).
- `SAM_checkpoint`: File path for SAM model checkpoint file.
    - Example: 'flood_detection/pretrained_checkpoint/sam_hq_vit_tiny.pth'.
- `model_type`: Type of SAM model to use. Options: 'vit_tiny', 'vit_b', etc. Example: 'vit_tiny'.
- `num_iterations`: Number of SAM iterations. Example: 20.
- `total_samples`: Total SAM prompt points. Example: 40.
- `min_samples_per_class`: Minimum prompt points per class (flood/non-flood). Example: 10.
- `mask_threshold`: Detection count threshold for SAM-based flood identification. Example: 10 (A pixel is confirmed as flooded if marked in ≥10 out of 20 independent SAM segmentation runs under majority voting).
- `mode`: Operation mode (options: 1 or 2).
    - 1: Generate more positive samples (flood pixels) - Recommended for confined floods (spatially concentrated inundation)
    - 2: Generate more negative samples (non-flood pixels) - Recommended for widespread floods (diffuse flooding)
    - Example: 1.
- `visualize`: Boolean flag for result visualization.
    - True: Display intermediate/final results
    - False: Disable visualization
    - Example: True.
- `output_folder_path`: Export directory for results.
    - Example: 'output'.
- `texture_bands` (optional): Texture bands to be used (if applicable). Example: None (indicates no texture features will be used; currently not used in main pipeline).

##  Output Results and Accuracy Assessment
- **Intermediate Results:**
    - Anomaly scores computed by Isolation Forest
    - Individual flood detection results from 16 TSMs
    - Flood detection results generated by SAM.
- **Final Outputs:**
    - Integrated flood detection results combining TSM and SAM.
    - Accuracy metrics: Accuracy, precision, recall and F1-score.

## System Requirements
- Python 3.7+
- GDAL 3.0+
- CUDA (required for GPU acceleration of SAM)


## Python Dependencies
- numpy>=1.19.2
- pandas>=1.2.0
- gdal>=3.0.0
- scikit-learn>=0.24.0
- scikit-image>=0.18.0
- opencv-python>=4.5.0
- matplotlib>=3.3.0
- torch>=1.7.0
- rasterio>=1.2.0
- affine>=2.3.0
- geopandas>=0.9.0
- shapely>=1.7.0
- timm>=0.4.12
- requests>=2.25.0
- tqdm>=4.50.0
- torchvision>=0.8
- segment-anything-hq
- pycocotools
- onnxruntime
- onnx

Install all dependencies with:
```bash
pip install -r requirements.txt
```

## Model Weights
Download the SAM model weights (e.g., sam_hq_vit_tiny.pth) and place them in the `pretrained_checkpoint/` directory. You can use the provided script:
```bash
download_sam_weights.bat
```
Or download manually from the official [SAM-HQ repository](https://github.com/SysCV/sam-hq).

## Usage
1. Prepare your data:
   - Pre-flood satellite image (GeoTIFF)
   - Post-flood satellite image (GeoTIFF)
   - (Optional) ROI mask image (GeoTIFF)

2. Configure parameters in Python:
```python
params = {
    'regionname': 'YourRegion',                # Name of the region
    'change_method': 'rate_of_change',         # Change detection method: 'rate_of_change', 'difference', or 'ratio'
    'roi_type': 1,                             # ROI type: 1 (no ROI), 2 (ROI mask)
    'spectral_bands': [0, 1, 3],               # Bands to use (e.g., 0: VV, 1: VH, 3: VV/VH ratio)
    'filename1': 'data/BeforeFlooding.tif',    # Path to pre-flood image
    'filename2': 'data/AfterFlooding.tif',     # Path to post-flood image
    'filename3': None,                         # Path to ROI mask (optional)
    'combined_threshold': 13,                  # TSM voting threshold (e.g., 13/16)
    'SAM_checkpoint': 'pretrained_checkpoint/sam_hq_vit_tiny.pth', # Path to SAM weights
    'model_type': 'vit_tiny',                  # SAM model type
    'num_iterations': 20,                      # Number of SAM iterations
    'total_samples': 40,                       # Total SAM prompt points
    'min_samples_per_class': 10,               # Minimum prompt points per class
    'mask_threshold': 18,                      # SAM voting threshold (e.g., 18/20)
    'mode': 2,                                 # 1: more positive samples, 2: more negative samples
    'visualize': True,                         # Whether to visualize results
    'output_folder_path': 'output'             # Output directory
}
```

3. Run the analysis:
```python
from src.main import flood_analysis_pipeline
flood_mask, output_paths = flood_analysis_pipeline(params)
```

## Output Results
- **Merge**: Integrated result combining TSM and SAM
- **SAM**: Segmentation result from SAM only
- **TSM**: Segmentation result from TSMs only

All results are saved as GeoTIFF files with georeferencing in the specified output directory.

## Accuracy Evaluation
To evaluate detection accuracy, use the provided validation shapefile and the following function:
```python
from src.utils import PrecisionValidation
acc, precision, recall, f1 = PrecisionValidation(
    GroundTruth_shapefile_path='data/validation shpfile/FloodingArea.shp',
    Prediction_raster_path=output_paths['Merge'],
    GroundTruth_output_tif_path='output/ground_truth.tif'
)

```

